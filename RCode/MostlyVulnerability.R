######################################################################
######################### VULNERABILITY DATA #########################
######################################################################

GetSHDI<-function(ADM,ISO){
  SHDI<-read.csv2(paste0(dir,"/Data/Vulnerability/SHDI-Database.csv"),sep = ";")
  # Keep only the most recent year, sub-national data and the data from the country of interest
  SHDI%<>%group_by(iso_code)%>%filter(year==max(year) & iso_code==ISO & level=="Subnat")%>%
          dplyr::select(c(1,4,6:(ncol(SHDI)-1)))%>%as.data.frame()
  colnames(SHDI)[4:ncol(SHDI)]<-c("SHDI","HealthI","LivingStandI","EducationI","LifeExp","GrossNatInc","ExpectedSchoolYrs","MeanSchoolYrs")
  # Convert to numeric
  for(i in 4:ncol(SHDI)) SHDI[,i]<-as.numeric(SHDI[,i])
  # We don't want the log of the Gross National Income
  SHDI$GrossNatInc%<>%exp()
  # Get the polygon shapefile of the admin boundaries of the SHDI database
  SHDIpoly<-GetSHDIadmin(ISO)
  # Find which indices in the SHDI object correspond to ADM values
  # indies<-Poly2poly(SHDIpoly,ADM,SHDI)
  # Do this by checking for overlap with other boundaries
  crs(SHDIpoly)<-crs(ADM)
  ADM$GDLCODE<-vapply(1:nrow(ADM@data), function(i) over(ADM[i,],SHDIpoly)$gdlcode,
                      FUN.VALUE = character(1))
  # Bind the ADM data.frame with the GDL values
  # ADM$GDLCODE<-indies%>%arrange(indexADM)%>%pull(GDLCODE)
  ADM@data%<>%merge(dplyr::select(SHDI,-iso_code),by="GDLCODE",all.x=T)
  
  return(ADM)
}


#----------------------------------------------------------------------------
##--Extracting GDLCODES from SHDI polygons for each ADM level 2 polygons------

source("./RCode/AdminBoundaries.R")

#Read ADM UN and SHDI
ADM<-sf::st_read("./Data/AdminBoundaries/UNmap0_shp/BNDA_A2.shp",quiet=TRUE) %>%
  #projection(ADM)<-"+proj=longlat +datum=WGS84 +no_defs"
  dplyr::filter(ISO3CD==ISO) %>%
  dplyr::select(ISO3CD,ADM1NM,ADM2NM,ADM1CD,ADM2CD)
plot(ADM["ADM2NM"]) #sample plot

SHDI <- sf::st_read("./Data/AdminBoundaries/GDL/GDL Shapefiles V6/shdi2022_World_large.shp",quiet=TRUE)
st_crs(SHDI) <- st_crs(ADM)
SHDI <- SHDI[!is.na(SHDI$iso_code) & SHDI$iso_code ==ISO, ]

ADM_sub<-GetUNMaps(ISO)

#treat it polygon per polygon:
if(nrow(ADM_sub)>1){
  ADM_per_poly<-split(ADM_sub, f = ADM_sub[["ADM2NM"]])
}else{
  ADM_per_poly<-list(ADM_sub)
}


##Getting SHDI polygons per ADM polygons
sf_use_s2(FALSE) #affects buffering

SHDI_per_ADM<-list()

#consider different cases overlaps between ADM and SHDI polygons
if(nrow(ADM) >= nrow(SHDI)){ #which means that ADM maps smaller than SHDI
  
  for(i in seq_along(ADM_per_poly)){
    tryCatch(
      {
        p<-ADM_per_poly[[i]]
        #overlap with SHDI
        c<-st_intersection(st_make_valid(p),st_make_valid(SHDI))
        #%>%
        # st_cast("POLYGON")
        #biggest poly i.e. most overlap
        c_mx<-c[which.max(st_area(c)),]
        # #option 1; get centroid - problem if centroid lies outside the polygon!
        # c_mx_cent<-st_centroid(c_mx)
        #option 2: create arbitrary inner buffer, shrink poly to avoid touching other polys
        #make it depend on the size of polygon:
        if(as.numeric(st_area(c_mx)) < 1e7){ # in degrees since geographical units.
          buf <- -0.001
        }else{
          buf<- -0.01
        }
        c_buff<- c_mx %>%
          as(.,"Spatial") %>%
          rgeos::gBuffer(.,byid=FALSE, width=buf) %>%
          st_as_sf() %>%
          .[which.max(st_area(.)),]
        #extract/subset
        SHDI_per_ADM[[i]]<-SHDI[c_buff,]
        
      },
      error = function(e) {}
    )
  }
  
} else { #which means that ADM maps larger than SHDI
  
  for(i in seq_along(ADM_per_poly)){
    tryCatch(
      {
        p<-ADM_per_poly[[i]]
        #extract/subset that intersects
        SHDI_per_ADM[[i]]<-SHDI[st_intersects(SHDI,p,sparse=FALSE),]
      },
      error = function(e) {}
      
    )
  }
}


# #sample plot:
# #too 
# par(mfrow=c(2,5))
# for(i in seq_along(SHDI_per_ADM)){
#   plot(st_geometry(ADM),lwd=0.2)
#   a<-ADM_per_poly[[i]]
#   plot(st_geometry(a),add=TRUE,col="blue")
#   p<-SHDI_per_ADM[[i]]
#   plot(st_geometry(p), col=alpha("red",0.5),add=TRUE)
# }

##-------Get SHDI values using GLDCODES---------------------------

