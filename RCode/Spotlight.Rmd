---
output:
  html_document: default
---

```{r setting options and loading data, include=FALSE}
knitr::opts_chunk$set(echo =FALSE, message=FALSE, warning=FALSE)

load("codes_desc.RData")
sys.source("./GetINFORM.R", envir = knitr::knit_global())
#source("./GetINFORM.R")
sys.source("./GetWorldBank.R", envir = knitr::knit_global())
sys.source("./AdminBoundaries.R",envir = knitr::knit_global())


```

```{r selecting country}
#country select
country_full <- "Eswatini"
country_iso <- iso3$iso3[iso3$Country == country_full]
#Example "SSD"

pres_title <- country_full
pres_date <- Sys.Date()
```


---
title: `r pres_title`
---
## RiX Spotlight for Humanitarian Needs Overview



```{r fig.align="right", message=FALSE, out.width="20%"}
library(geodata)
a<-gadm(country_iso, level = 0, path=tempdir())
plot(a, col= "dodgerblue2", axes=FALSE)

```

```{r Combining tables, include = FALSE}
#Define df for matching numeric class with string class
Rank_class_df <- data.frame(Rank_class = 1:5, Class_levels = as.factor(c("Very Low","Low","Moderate","High","Very High")))
Rank_class_df$Class_levels <- factor(Rank_class_df$Class_levels ,levels = c("Very Low","Low","Moderate","High","Very High"))


#INFORM
country_inform <- lapply(Country_with_ranks, function(x) x[x$iso == country_iso,]) %>% #remove the iso column
  do.call(rbind, .) %>%
  {`[`(.[,-1])} %>% #remove column 1, which is the iso3 column
  t  %>%
  data.frame() %>%
  mutate(Index = rownames(.)) %>%
  select(Index, Value, Rank, Rank_out_of, Rank_class) %>%
  #plyr::join(., Rank_class_df, by="Rank_class") %>%
  filter(complete.cases(.)) %>%
  left_join(.,Inform_codes_desc, by = c("Index" = "INFORM.Id")) %>% #add description and source
  mutate(Source = "DRMKC INFORM, Mid 2022", Year = year) #adapt as variable!


#WORLD BANK
country_wbank <- lapply(WB_data_all, function(x) x[x$iso3 == country_iso,]) %>%
  do.call(rbind,.) %>%
  mutate(Indicator = row.names(.)) %>% 
  #plyr::join(., Rank_class_df, by="Rank_class") %>%
  select("Indicator", "Value","Year", "Rank","Rank_out_of", "Rank_class") %>%
  arrange(Indicator) %>%
  left_join(.,Wbank_codes_desc, by = c("Indicator" = "Variable.API.Name")) %>% #add description and source
  mutate(across(everything(), as.vector)) %>% #remove any attribute label
  rename(Index = Indicator)


#Combine WORLDBANK and INFORM datasets
country_all <- plyr::rbind.fill(country_inform,country_wbank) %>%
  plyr::join(., Rank_class_df, by="Rank_class") %>%
  mutate(Group = case_when(grepl("INFORM", Index) == TRUE ~ "a) Risk Index",
         grepl("HA|FRST|PRCP|ATM| ", Index) == TRUE ~ "b) Hazards & Exposure", 
         grepl("VU|MORT|VUL|EMP|UEM ", Index) == TRUE ~ "c) Vulnerability", 
         grepl("CC", Index) == TRUE ~ "d) Lack fo Coping Capacity")) %>%
  mutate(Description = " ") %>%
  arrange(Group)


#ADM shapefiles, group by iso3cd-------
adm.country<-adm_group[adm_group$iso == country_iso,] %>%
  {`[`(.[,-1])} %>% #remove column 1, which is the iso3 column
  t %>%
  data.frame() %>%
  round(.,2) %>%
  `colnames<-`("Mean Value") %>%
  mutate(Code = row.names(.)) %>%
  left_join(.,adm_labels, by = c("Code" = "GDLCODE")) %>%
  select("Description", "Mean Value") %>%
  filter(complete.cases(.))
  

```

## Basic Risk Data
```{r Global Indices Table}
library(kableExtra)
source("./Spotlight_plotting_functions.R")
#------Combined WBANK+INFORM table plot---------
#tile color
country_all$Class_levels <-  color_tile2(c("forestgreen",'lightgoldenrod2', "firebrick1"))(country_all$Class_levels)

country_all[c(5,2:3,10,7,8,6)] %>%
  kbl(escape=F) %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(c(4,7), width_min = c("8cm","5cm"), width_max = c("8cm","5cm")) %>%
  pack_rows(index = table(country_all$Group)) # %>%
  # add_indent(row.ind1 , level_of_indent = 1) %>%
  # add_indent(row.ind2 , level_of_indent = 2) %>%
  #add_header_above(c("Basic Risk Data" =7), font_size = "medium")
```


## Country Statistics
```{r Country Stats table, message=FALSE, warning=FALSE}
# #table shapefile
adm.country %>%
  kbl() %>%
  kable_paper("striped", full_width = T) %>%
  column_spec(1:2, width = c("2cm","3cm")) 
# %>%
#   add_header_above(c("Country Statistics" = 2), font_size = "medium")

```





