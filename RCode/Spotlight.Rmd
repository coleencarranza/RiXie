```{r setting options and loading data, include=FALSE}
knitr::opts_chunk$set(echo =FALSE, message=FALSE, warning=FALSE)

load("codes_desc.RData") #returns error, but seems to be working!
sys.source("./GetWorldBank.R", envir = knitr::knit_global())
sys.source("./GetINFORM.R", envir = knitr::knit_global())
sys.source("./AdminBoundaries.R",envir = knitr::knit_global())
```

```{r selecting country}
#country select
# country_full <- "Madagascar"
# country_iso <- iso3$iso3[iso3$Country == country_full]
#Example "SSD"

pres_title <- country_full
pres_date <- Sys.Date()
```
---
title: `r pres_title` RiX Spotlight
subtitle: "For Humanitarian Needs Overview"
output:
  html_document:
      css: styles.css
---

<style type="text/css">
h1.title {
  font-size: 50px;
  color: Grey;
  text-align: right;
}
h3.subtitle {
  font-size: 30px;
  color: Grey;
  text-align: right;
}
.table-hover > tbody > tr:hover { 
  background-color: #f7f7e6;
}
.main-container {
  width: 80%;
    max-width: unset;
  }
</style>


<div style= "float:left; position:relative; top:-100px;margin-bottom:-100px;margin-left:-10px;">
```{r  country and flag , message=FALSE, out.width="25%"}
#,out.extra='style="float: left"'
library(geodata)
library(ggflags)
library(ggplot2)
library(ggthemes)
library(sf)
#Coutnry shapefile
country_gadm <-gadm(country_iso,level=1, path= tempdir()) %>%
  st_as_sf
adm_plot <- ggplot(country_gadm, lwd= 0.15) +
  geom_sf(fill = "steelblue2") + theme_void()
adm_plot

#plot flag

```
</div>
<!-- ## Basic Risk Data -->
```{r Global Indices Tables}
#-------WORLD BANK------
oldnames <- c("Indicator", "Year")
newnames <- c("Index", "Year of Publication")

country_wbank <- lapply(WB_data_all, function(x) x[x$iso3 == country_iso,]) %>%
  do.call(rbind,.) %>%
  mutate(Indicator = row.names(.)) %>% 
  #plyr::join(., Rank_class_df, by="Rank_class") %>%
  select("Indicator", "Value","Year", "Rank","Rank_out_of", "Rank_class") %>%
  arrange(Indicator) %>%
  left_join(.,Wbank_codes_desc, by = c("Indicator" = "Variable.API.Name")) %>% #add description and source
  mutate(across(everything(), as.vector)) %>% #remove any attribute label
  rename_at(vars(oldnames), ~ newnames) %>%
  mutate(URL = as.character("https://data.worldbank.org/")) %>%
  mutate(Unit = as.character(""))

#------INFORM-----
country_inform <- lapply(Country_with_ranks, function(x) x[x$iso == country_iso,]) %>% #remove the iso column
  do.call(rbind, .) %>%
  {`[`(.[,-1])} %>% #remove column 1, which is the iso3 column
  t  %>%
  data.frame() %>%
  mutate(Index = rownames(.)) %>%
  select(Index, Value, Rank, Rank_out_of, Rank_class) %>%
  #plyr::join(., Rank_class_df, by="Rank_class") %>%
  filter(complete.cases(.)) %>%
  left_join(.,Inform_codes_desc, by = c("Index" = "INFORM.Id")) %>% #add description and source
  mutate(Source = dataset, `Year of Publication` = inform_year) %>%
  mutate(URL = as.character("https://drmkc.jrc.ec.europa.eu/inform-index")) %>%
  mutate(Unit = as.character("(scale 0-10)"))
```

```{r Combining tables}
#-----Combine WORLDBANK and INFORM datasets-------
#function to group indicators/incides
indicator_group <-function(indicator){
 if(grepl("INFORM", indicator) == TRUE ){
   grp <- "Risk Index"
 } else if (grepl("HA|FRST|PRCP|ATM| ", indicator) == TRUE){
   grp <- "Hazard"
 } else {
   grp <- "Vulnerability"
 }
  
 #  else if (grepl("VU|MORT|VUL|EMP|UEM|CC ", indicator) == TRUE){
 #   grp <- "Vulnerability"
 # } else {
 #  grp <-"To be classified"
 # }
}

#Define df for matching numeric class with string class
Rank_class_df <- data.frame(Rank_class = 1:5, Class_levels = as.factor(c("Very Low","Low","Moderate","High","Very High")))
Rank_class_df$Class_levels <- factor(Rank_class_df$Class_levels ,levels = c("Very Low","Low","Moderate","High","Very High"))

#order or groupings for table:
target_grp <- c("Risk Index", "Hazard","Exposure", "Vulnerability","Others -to be classified") 

country_all <- plyr::rbind.fill(country_inform, country_wbank) %>%
  plyr::join(., Rank_class_df, by="Rank_class") %>%
  #mutate(Rank = paste(Rank, Rank_out_of, sep = "/")) %>%
  select(-Rank_class) %>%
  mutate(Description = " ") %>%
  mutate(Category = sapply(.$Index, indicator_group)) %>%
  arrange(factor(Category, levels = target_grp)) %>%
  rename_at(vars(c("Indicator.Name","Class_levels")),~ c("Index_name","Comparative Value"))
```

```{r, include=FALSE}
###------------------------TABLE---------------------------------------------------------------------------
library(kableExtra)
library(forcats)
source("./Spotlight_plotting_functions.R")
#------Combined WBANK+INFORM table plot---------
#tile color
#country_all$`Comparative Value` <- color_tile2(c("palegreen3",'lightgoldenrod1', "tomato2"))(country_all$`Comparative Value`) #c("#9DBF9E", "#FCB97D", "#A84268")

#Rows from inform need indentation (sublevels)
inform_row_indent <- function(df, level){
  df %>%  
  mutate(row=row_number()) %>% 
  filter(grepl("INFORM", Source)) %>% 
  filter(str_count(Index, '\\.') == level) %>%
  select(row) %>%
  unlist(.) %>%
  unname(.)
}

ind1 <- inform_row_indent(country_all,level=1)
ind2 <-  inform_row_indent(country_all,level=2)

# country_all[c("Index_name","Description","Value","Year of Publication","Rank","Comparative Value","Source")] %>%
#   tibble()%>%
#   kbl(escape=F, align = 'lcccrcl') %>%
#   kable_paper("striped", full_width = T, font_size = 13) %>%
#   column_spec(c(1,2,7), width_min = c("6cm","6cm","5cm"), width_max = c("15cm","6cm","5cm")) %>%
#   pack_rows(index = table(fct_inorder(country_all$Category))) %>%
#   column_spec(6, color = "white",
#               background = spec_color(as.numeric(country_all$`Comparative Value`),alpha = 0.75, end = 0.4, option = "inferno")) %>%
#   add_indent(ind1, level_of_indent = 0.5) %>%
#   add_indent(ind2, level_of_indent = 1) 
```

<!-- ## Country Statistics -->
```{r Country Stats table, message=FALSE, warning=FALSE, include=FALSE}

#--------ADM shapefiles, group by iso3cd-------
#function changing rank to string:
Ranking <- function(Rank, Rank_out_of){
  if(!is.na(Rank) == TRUE){
    paste(Rank, Rank_out_of, sep = "/")
    } else {
      NA
    }
}

#Subset table
var_select <-c("Codes","Category", "Description", "Mean_Value","Unit","Year_of_Publication", "Rank", "Rank_out_of","Class_levels", "Organisation", "URL")
#Grouping names
target_adm <- c("Hazard", "Exposure", "Vulnerability", "Climate Change")

## changing headers for table:
oldnames <- c("Class_levels", "Year_of_Publication", "Mean_Value", "Organisation", "Codes", "Description")
newnames <- c("Comparative Value", "Year of Publication", "Value", "Source", "Index", "Index_name") ##it's the mean value per country but labeling as `Value` to be same as basic risk data table column names 

adm_country <- lapply(adm_ranks, function(x) t(x[x$iso == country_iso,][-1])) %>%
  lapply(., data.frame, check.names=FALSE) %>%
  do.call(cbind, .) %>%
  `colnames<-`(c("Mean_Value", "Rank", "Rank_out_of","Rank_class")) %>%
  #mutate(Rank = mapply(function(x,y) Ranking(x,y), Rank,Rank_out_of)) %>%
  mutate(Codes = rownames(.)) %>%
  select(Codes, Mean_Value, Rank, Rank_out_of, Rank_class) %>%
  plyr::join(., Rank_class_df, by="Rank_class") %>%
  mutate(Mean_Value = round(Mean_Value,2) ) %>%
  #mutate(Rank_class  = ifelse(is.na(Rank_class)==TRUE,1,Rank_class)) %>% # to deal with NAs in Rank, for plotting later
  left_join(., adm_sources, by = c("Codes" = "GDLCODE")) %>% #add description and source
  select(var_select) %>%
  rename_at(vars(oldnames), ~ newnames) %>%
 # mutate(Source = paste0(Source," (",URL,")" )) %>%
  arrange(factor(Category, levels = target_adm)) %>%
  filter(complete.cases(Category))

#----------------------------------TABLE-----------------------------------------------------------
#tile color
# adm_country$`Comparative Value` <- ifelse(is.na(adm_country$`Comparative Value`),NA,color_tile2(c("palegreen3",'lightgoldenrod1', "tomato2"))(adm_country$`Comparative Value`))
#   
  
#table shapefile
adm_country[c(2,3,4,5,7,8)] %>%
   kbl(escape=F, align = 'lccccl') %>%
  kable_paper("striped", full_width = T, font_size = 13) %>%
  column_spec(c(1,6), width_min = c("8cm","5cm"), width_max = c("8cm","5cm")) %>%
  pack_rows(index = table(fct_inorder(adm_country$Category))) %>%
  column_spec(5, color = "white",
              background = spec_color(as.numeric(adm_country$`Comparative Value`),alpha = 0.75, end = 0.4, option = "inferno"))
# %>%
#   add_header_above(c("Country Statistics" = 2), font_size = "medium")
```


```{r}
#--------------------MERGE basic risk and country stats dfs----------
all<-plyr::rbind.fill(country_all,adm_country) %>%
  mutate(URL =paste0("[",URL, "](", URL, ")")) %>%
  mutate(Description = as.character(paste0("The ", tolower(Index_name)," ",Unit," for ", country_full," is estimated to be ",
                                           Value, ", which is considered as ", `Comparative Value`," risk as compared to ",
                                           Rank_out_of," other countries. Additionally, ",country_full," ranks at ",Rank," out of ",Rank_out_of,
                                           " around the world. These estimates were taken from ",Source,", made in ",`Year of Publication`,". (", URL,")"))) %>%
  rename(Name = Index_name) %>%
  arrange(factor(Category, levels = target_grp), Name) %>%
  filter(!grepl("HA",Index))

#table big
all[c(5,10,11)] %>%
  kbl(escape=F, align = 'rcl') %>%
  #kable_paper(full_width = T, font_size = 14) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),full_width = T, font_size = 14) %>%
  column_spec(1, bold = T, width = "5em", border_right = T, extra_css = "vertical-align:middle;") %>%
  column_spec(2,width = "3em", color = "white", extra_css = "vertical-align:middle;",
              background = spec_color(as.numeric(all$`Comparative Value`),alpha = 0.5, end = 0.4, option = "inferno"))%>%
  column_spec(3, width = "60em")%>%
  pack_rows(index = table(fct_inorder(all$Category)), hline_before = T, bold=T) 

```



